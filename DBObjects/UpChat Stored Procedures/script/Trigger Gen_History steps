EXEC sp_configure 'show advanced options', 1;
RECONFIGURE;

EXEC sp_configure 'clr strict security', 0;
RECONFIGURE;

---Create assembly
IF NOT EXISTS (SELECT * FROM sys.assemblies WHERE name = 'UpChatAssembly')
BEGIN
    -- Assembly does not exist, so create it
    CREATE ASSEMBLY UpChatAssembly
	FROM 'D:\TFSProjects\UpChatClassLibrary\UpChatClassLibrary\bin\Debug\UpChatClassLibrary.dll'
	WITH PERMISSION_SET = EXTERNAL_ACCESS;
END

--Create Sproc_UpChat_AddHRActivityInChats which call Assembly
CREATE PROCEDURE dbo.Sproc_UpChat_AddHRActivityInChats(@apiUrl NVARCHAR(200))
AS EXTERNAL NAME UpChatAssembly.[UpChatClassLibrary.WebApiCaller].CallWebApi;

--Create table for verified the API URLs
IF NOT EXISTS (SELECT 1 FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA = 'dbo' AND TABLE_NAME = 'StoreAPIURL')
BEGIN
	CREATE TABLE StoreAPIURL(HRID BIGINT, HistoryID BIGINT, APIUrl NVARCHAR(MAX), IsAddedInFirebased INT)
END

--Trigger for Gen_History
CREATE TRIGGER Trigger_Insert_Gen_History
ON gen_history
AFTER INSERT
AS
BEGIN
	DECLARE 
	@UpChatAPI_URL NVARCHAR(200),
	@HrID BIGINT, 
	@HistoryID BIGINT,
	@AppActionDoneBy INT
	
	SET @UpChatAPI_URL = N'https://localhost:7051/'

	SELECT TOP 1 @HrID = HiringRequest_ID, @HistoryID = id, @AppActionDoneBy = AppActionDoneBy FROM inserted;

	IF @AppActionDoneBy = 3 and @HrID > 0 and @HistoryID > 0
	BEGIN
	    DECLARE @APIURL NVARCHAR(MAX);
		SET @APIURL = @UpChatAPI_URL + 'Channel/AddHRActivityInChats?HrID=' + CAST(@HrID as NVARCHAR(100)) + '&HistoryID=' + CAST(@HistoryID as NVARCHAR(100));

		INSERT INTO StoreAPIURL(HRID ,HistoryID, APIUrl, IsAddedInFirebased)
		VALUES(@HrID,@HistoryID,@APIURL,0)

		EXEC dbo.Sproc_UpChat_AddHRActivityInChats @APIURL;
	END
END;

